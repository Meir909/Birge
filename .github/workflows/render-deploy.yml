name: ğŸš€ Deploy to Render

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '18'
  
jobs:
  # Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
  test:
    name: ğŸ§ª Test
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: |
          cd server && npm ci
          cd ../biroad-front && npm ci
          
      - name: ğŸ” Run tests
        run: |
          cd server && npm test || true
          
      - name: ğŸ” Lint code
        run: |
          cd server && npm run lint || true

  # Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ±ÑĞºĞµĞ½Ğ´Ğ° Ğ½Ğ° Render
  deploy-backend:
    name: ğŸ”§ Deploy Backend to Render
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: |
          cd server
          npm ci --production
          
      - name: ğŸ”¨ Build backend
        run: |
          cd server
          npm run build
          
      - name: ğŸš€ Trigger Render Deploy
        run: |
          # Render Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¸Ñ‚ Ğ¿Ñ€Ğ¸ Ğ¿ÑƒÑˆĞµ Ğ² main
          echo "âœ… Backend deployment triggered on Render"
          
      - name: â³ Wait for Render deployment
        run: |
          echo "â³ Waiting for Render to complete deployment..."
          sleep 60

  # Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ñ„Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´Ğ° Ğ½Ğ° Render
  deploy-frontend:
    name: ğŸ¨ Deploy Frontend to Render
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: |
          cd biroad-front
          npm ci
          
      - name: ğŸ”¨ Build frontend
        run: |
          cd biroad-front
          npm run build
          
      - name: ğŸš€ Trigger Render Deploy
        run: |
          # Render Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¸Ñ‚ Ğ¿Ñ€Ğ¸ Ğ¿ÑƒÑˆĞµ Ğ² main
          echo "âœ… Frontend deployment triggered on Render"
          
      - name: â³ Wait for Render deployment
        run: |
          echo "â³ Waiting for Render to complete deployment..."
          sleep 60

  # Health check Ğ¿Ğ¾ÑĞ»Ğµ Ğ´ĞµĞ¿Ğ»Ğ¾Ñ
  health-check:
    name: ğŸ” Health Check
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ” Check API Health
        run: |
          sleep 120 # Ğ–Ğ´ĞµĞ¼ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° API
          API_URL="https://biroad-backend.onrender.com"
          response=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL/api/health" || echo "000")
          
          if [ "$response" = "200" ]; then
            echo "âœ… API Health Check Passed"
          else
            echo "âŒ API Health Check Failed: $response"
            echo "ğŸ“‹ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ»Ğ¾Ğ³Ğ¸ Ğ½Ğ° Render dashboard"
            exit 1
          fi
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ„Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´Ğ°
          FRONTEND_URL="https://biroad-frontend.onrender.com"
          response=$(curl -s -o /dev/null -w "%{http_code}" "$FRONTEND_URL" || echo "000")
          
          if [ "$response" = "200" ]; then
            echo "âœ… Frontend Health Check Passed"
          else
            echo "âŒ Frontend Health Check Failed: $response"
            echo "ğŸ“‹ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ»Ğ¾Ğ³Ğ¸ Ğ½Ğ° Render dashboard"
            exit 1
          fi

  # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ñ€ĞµĞ»Ğ¸Ğ·Ğ°
  release:
    name: ğŸ·ï¸ Create Release
    runs-on: ubuntu-latest
    needs: health-check
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ğŸ·ï¸ Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          release_name: ğŸš€ BIRoad v${{ github.run_number }} on Render
          body: |
            ## ğŸš€ ĞĞ¾Ğ²Ğ¾Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ BIRoad Ğ½Ğ° Render
            
            ### âœ¨ Ğ§Ñ‚Ğ¾ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾:
            - ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ½Ğ° Render
            - Backend Web Service Ñ MongoDB
            - Frontend Static Site
            - Health checks Ğ¸ Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³
            - SSL ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ñ‹ Ğ¸ CDN
            
            ### ğŸ”— Ğ¡ÑÑ‹Ğ»ĞºĞ¸:
            - ğŸ¨ Ğ¤Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´: https://biroad-frontend.onrender.com
            - ğŸ”§ Ğ‘ÑĞºĞµĞ½Ğ´: https://biroad-backend.onrender.com
            - ğŸ“Š Render Dashboard: https://dashboard.render.com
            
            ### ğŸ“¦ Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ:
            - Commit: ${{ github.sha }}
            - ĞĞ²Ñ‚Ğ¾Ñ€: ${{ github.actor }}
            
            ---
            ğŸ¤– ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ñ€ĞµĞ»Ğ¸Ğ· Ğ¾Ñ‚ GitHub Actions + Render
          draft: false
          prerelease: false

  # Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾ Ğ´ĞµĞ¿Ğ»Ğ¾Ğµ
  notify:
    name: ğŸ“¢ Notify
    runs-on: ubuntu-latest
    needs: [health-check]
    if: always()
    
    steps:
      - name: ğŸ“¢ Send notification
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#deployments'
          text: |
            ğŸš€ BIRoad Render Deployment Status: ${{ job.status }}
            
            Frontend: https://biroad-frontend.onrender.com
            Backend: https://biroad-backend.onrender.com
            Dashboard: https://dashboard.render.com
            
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        if: always()

  # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ğ¸
  update-docs:
    name: ğŸ“š Update Documentation
    runs-on: ubuntu-latest
    needs: release
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“ Update deployment status
        run: |
          echo "## ğŸš€ Render Deployment Status" >> DEPLOYMENT.md
          echo "" >> DEPLOYMENT.md
          echo "âœ… **Successfully deployed to Render!**" >> DEPLOYMENT.md
          echo "" >> DEPLOYMENT.md
          echo "### ğŸ”— Links:" >> DEPLOYMENT.md
          echo "- ğŸ¨ Frontend: https://biroad-frontend.onrender.com" >> DEPLOYMENT.md
          echo "- ğŸ”§ Backend: https://biroad-backend.onrender.com" >> DEPLOYMENT.md
          echo "- ğŸ“Š Dashboard: https://dashboard.render.com" >> DEPLOYMENT.md
          echo "" >> DEPLOYMENT.md
          echo "### ğŸ“… Last updated:" >> DEPLOYMENT.md
          echo "- $(date)" >> DEPLOYMENT.md
          echo "- Commit: ${{ github.sha }}" >> DEPLOYMENT.md
          echo "- Author: ${{ github.actor }}" >> DEPLOYMENT.md
          
      - name: ğŸ“¤ Commit documentation update
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add DEPLOYMENT.md
          git commit -m "ğŸ“ Update Render deployment status [skip ci]" || true
          git push || true
