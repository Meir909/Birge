name: ğŸš€ Deploy BIRoad

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '18'
  
jobs:
  # Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
  test:
    name: ğŸ§ª Test
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: |
          npm ci
          cd server && npm ci
          
      - name: ğŸ” Run tests
        run: |
          cd server && npm test
          
      - name: ğŸ” Lint code
        run: |
          cd server && npm run lint

  # Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ñ„Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´Ğ° Ğ½Ğ° Vercel
  deploy-frontend:
    name: ğŸ¨ Deploy Frontend
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: |
          cd biroad-front
          npm ci
          
      - name: ğŸ”¨ Build frontend
        run: |
          cd biroad-front
          npm run build
          
      - name: ğŸš€ Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./biroad-front
          vercel-args: '--prod'

  # Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ±ÑĞºĞµĞ½Ğ´Ğ° Ğ½Ğ° Railway
  deploy-backend:
    name: ğŸ”§ Deploy Backend
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: |
          cd server
          npm ci --production
          
      - name: ğŸ”¨ Build backend
        run: |
          cd server
          npm run build
          
      - name: ğŸš€ Deploy to Railway
        uses: railway-app/railway-action@v1
        with:
          api-token: ${{ secrets.RAILWAY_TOKEN }}
          service: ${{ secrets.RAILWAY_SERVICE_ID }}
          working-directory: ./server

  # Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ğ¸
  deploy-docs:
    name: ğŸ“š Deploy Docs
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          publish_branch: gh-pages

  # Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾ Ğ´ĞµĞ¿Ğ»Ğ¾Ğµ
  notify:
    name: ğŸ“¢ Notify
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend]
    if: always()
    
    steps:
      - name: ğŸ“¢ Send notification
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#deployments'
          text: |
            ğŸš€ BIRoad Deployment Status: ${{ job.status }}
            
            Frontend: https://biroad.vercel.app
            Backend: https://biroad-backend.railway.app
            
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        if: always()

  # Health check Ğ¿Ğ¾ÑĞ»Ğµ Ğ´ĞµĞ¿Ğ»Ğ¾Ñ
  health-check:
    name: ğŸ” Health Check
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ” Check API Health
        run: |
          sleep 30 # Ğ–Ğ´ĞµĞ¼ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° API
          API_URL="https://biroad-backend.railway.app"
          response=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL/api/health")
          
          if [ "$response" = "200" ]; then
            echo "âœ… API Health Check Passed"
          else
            echo "âŒ API Health Check Failed: $response"
            exit 1
          fi
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ„Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´Ğ°
          FRONTEND_URL="https://biroad.vercel.app"
          response=$(curl -s -o /dev/null -w "%{http_code}" "$FRONTEND_URL")
          
          if [ "$response" = "200" ]; then
            echo "âœ… Frontend Health Check Passed"
          else
            echo "âŒ Frontend Health Check Failed: $response"
            exit 1
          fi

  # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ñ€ĞµĞ»Ğ¸Ğ·Ğ°
  release:
    name: ğŸ·ï¸ Create Release
    runs-on: ubuntu-latest
    needs: [health-check]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ğŸ·ï¸ Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          release_name: ğŸš€ BIRoad v${{ github.run_number }}
          body: |
            ## ğŸš€ ĞĞ¾Ğ²Ğ¾Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ BIRoad
            
            ### âœ¨ Ğ§Ñ‚Ğ¾ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾:
            - ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ½Ğ° Vercel + Railway
            - Health checks Ğ¸ Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³
            - Ğ£Ğ»ÑƒÑ‡ÑˆĞµĞ½Ğ½Ğ°Ñ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ
            - ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ
            
            ### ğŸ”— Ğ¡ÑÑ‹Ğ»ĞºĞ¸:
            - ğŸ¨ Ğ¤Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´: https://biroad.vercel.app
            - ğŸ”§ Ğ‘ÑĞºĞµĞ½Ğ´: https://biroad-backend.railway.app
            - ğŸ“š Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ: https://docs.biroad.vercel.app
            
            ### ğŸ“¦ Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ:
            - Commit: ${{ github.sha }}
            - ĞĞ²Ñ‚Ğ¾Ñ€: ${{ github.actor }}
            
            ---
            ğŸ¤– ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ñ€ĞµĞ»Ğ¸Ğ· Ğ¾Ñ‚ GitHub Actions
          draft: false
          prerelease: false
